@startuml
actor User
participant System
participant API
participant "DBagent"
database "VectorDB" as DB
participant Transformer
participant Report

autonumber
title Report Generation Process

User -> System: select(ticker, daterange)
System -> Report **: create
System -> API: batch_get_collections()
API --> System: return(collections)
System -> DBagent: batch_embed(collections)
loop#lightblue #lightblue For each collection
    DBagent -> DBagent: tokenize(collection)
    DBagent -> DB: upsert(documents, metadatas, ids)
    DB --> DBagent: Confirm
end

DBagent --> System: Confirm
loop#lightyellow #lightyellow While Report is generating
    System -> DBagent: get_context(prompt, fromYear, ticker)
    DBagent -> DB: query(prompt, years)
    DB --> DBagent: return(data)
    DBagent -> DBagent: format_metadata_citation()
    DBagent -> Transformer: transform(context, prompt)
    Transformer -> Transformer: generate(context, prompt)
    Transformer --> System: return(output)
    System -> Report: write(output)
    Report --> System: Confirm
end

System --> User: Confirm

@enduml